# 云函数部署说明

## 语音识别功能无法使用的解决方案

### 问题诊断

语音识别功能依赖微信云开发的云函数 `voiceRecognition`，如果无法识别语音，通常是以下原因：

1. **云函数未部署到云端**
2. **百度语音识别API密钥无效**
3. **云开发环境未正确配置**

### 解决步骤

#### 1. 部署云函数

在微信开发者工具中：

1. 打开项目后，点击工具栏的"云开发"按钮
2. 进入云开发控制台，确保云环境已创建（当前环境ID: `cloud1-5g4dtvhvbb57a72b`）
3. 在左侧文件目录中，找到 `cloudfunctions/voiceRecognition` 文件夹
4. 右键点击 `voiceRecognition` 文件夹
5. 选择"上传并部署：云端安装依赖"
6. 等待部署完成（会自动安装 `wx-server-sdk` 和 `request` 依赖）

#### 2. 验证云函数是否部署成功

1. 在云开发控制台中，点击左侧"云函数"
2. 查看函数列表中是否有 `voiceRecognition`
3. 点击函数名称，查看函数详情和日志

#### 3. 配置百度语音识别API（可选）

当前云函数使用百度语音识别API，如果识别失败，可能需要更新API密钥：

1. 访问 [百度AI开放平台](https://ai.baidu.com/)
2. 注册/登录账号
3. 创建"语音识别"应用
4. 获取 API Key 和 Secret Key
5. 修改 `cloudfunctions/voiceRecognition/index.js` 中的配置：

```javascript
const BAIDU_API_KEY = '你的API_KEY'
const BAIDU_SECRET_KEY = '你的SECRET_KEY'
```

6. 重新上传部署云函数

#### 4. 测试语音识别

1. 在小程序中进入"语音速记"页面
2. 点击"开始录音"按钮
3. 说话后点击"停止录音"
4. 查看控制台日志，现在会显示详细的错误信息：
   - 上传音频文件的状态
   - 云函数调用的参数和返回结果
   - 具体的错误原因

### 常见错误及解决方法

#### 错误1: "云函数不存在"
**原因**: 云函数未部署
**解决**: 按照步骤1部署云函数

#### 错误2: "errCode: -1, errMsg: cloud.callFunction:fail"
**原因**: 云开发环境未初始化或环境ID不正确
**解决**:
- 检查 `app.js` 中的云环境ID是否正确
- 确保在微信开发者工具中开启了云开发

#### 错误3: "识别失败: err_no: 3301"
**原因**: 百度API密钥无效或配额用尽
**解决**:
- 更新百度API密钥（步骤3）
- 检查百度控制台的API调用配额

#### 错误4: "上传文件失败"
**原因**: 云存储权限问题
**解决**:
- 在云开发控制台的"存储"中，检查权限设置
- 建议设置为"所有用户可读，仅创建者可写"

### 调试技巧

1. **查看控制台日志**: 现在代码会输出详细的日志信息
2. **查看云函数日志**: 在云开发控制台的"云函数"中查看函数执行日志
3. **测试云函数**: 在云开发控制台中可以直接测试云函数

### 备用方案

如果百度API无法使用，可以考虑：

1. **使用微信同声传译API** (需要企业认证)
2. **使用腾讯云语音识别** (需要开通腾讯云服务)
3. **使用讯飞语音识别** (需要注册讯飞开放平台)

### 当前代码改进

已在 `pages/record/voice/voice.js` 中添加了详细的错误日志和提示：

- 上传音频时会显示文件路径
- 调用云函数时会显示参数
- 返回结果会完整输出到控制台
- 错误时会弹出详细的错误对话框，包含可能的原因和解决建议

### 下一步

1. 在微信开发者工具中部署云函数
2. 测试语音识别功能
3. 查看控制台和云函数日志
4. 根据具体错误信息进行调试
